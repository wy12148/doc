# 可观测性实践笔记（Trace 与 Metrics 一致化方案）

最后更新：2025-10-12

本篇整理与规范化了当前可观测实践（结合之前工作中 HCI 场景），并围绕 Trace 与 Metrics 的“同构化管道”展开：应用集成 OTel SDK → 主机边缘 OTel Collector（Agent）→ 中心 OTel Collector → 后端存储（Jaeger / VictoriaMetrics）→ Grafana 分析。

—

## 1. 背景与目标

- 目标：在统一的采集与传输链路下，同时覆盖分布式追踪（Trace）与度量（Metrics），并沉淀稳定、可扩展、便于排障的落地方案。
- 现状要点（修订版）：
	- 应用/服务集成 OTel SDK（采集 Trace 与应用内手动 Metrics）；
	- 数据通过 OTLP 直接发送到本机“边缘 OTel Collector（Agent）”；
	- 边缘 Collector 做初步聚合/批处理/属性补齐后，统一发往“中心 OTel Collector”；
	- 中心 Collector 进行分流：
		- Traces → Jaeger 存储端；
		- Metrics → VictoriaMetrics 存储端；
	- 最终使用 Grafana 进行查询、分析与可视化；

简言之：Trace 与 Metrics 在“采集—传输—存储—可视化”四段式链路上高度相似，只是后端不同。

—

## 2. 核心概念速览

- 可观测性（Observability）：通过外部可见的信号（Trace/Metrics/Logs 等）理解系统内部状态与行为能力。
- Trace（分布式追踪）：记录一次请求在各服务间的调用链与时序信息，定位慢调用、错误与跨服务瓶颈。
- Metrics（度量）：按时间序列记录数值型指标（计数、测量、直方图等），用于监控、告警与趋势分析。
- Logs（日志）：事件文本或结构化记录，便于审计、调试与深度取证。
- Exemplars（示例点）：把单个样本点与 TraceID 关联起来，实现指标到具体 Trace 的“点对链路”跳转。

—

## 3. 总体架构与数据流

组件清单：
- 应用侧：OTel SDK（Trace + 手动业务 Metrics，导出 OTLP）
- 本机 Agent：边缘 OTel Collector（接收 OTLP，必要时也接收 Jaeger 作为兼容）
- 汇聚与分流：中心 OTel Collector（统一处理与导出）
- 存储：
	- Jaeger 存储（通常包含 collector/query/存储后端）
	- VictoriaMetrics（Prometheus 协议兼容时序数据库）
- 可视化：Grafana（连接 Jaeger 与 VictoriaMetrics 数据源）

数据流（示意）：

应用/服务（集成 OTel SDK）
	├─ Traces（OTLP）→ 本机 边缘 OTel Collector（receivers.otlp）
	│                      → 中心 OTel Collector（exporters.otlp → receivers.otlp）
	│                      → Jaeger 存储/查询
	└─ Metrics（OTLP，自定义/手动埋点）→ 边缘 OTel Collector（receivers.otlp）
													 → 中心 OTel Collector
													 → VictoriaMetrics（Prometheus Remote Write）

Grafana 配置两个数据源：
- Traces：Jaeger Data Source（或 Tempo/OTel 兼容源）
- Metrics：Prometheus 兼容数据源（指向 VictoriaMetrics）

—

## 4. 组件职责与典型端口

- OTel SDK
	- 在应用内埋点/自动探针，生成 Trace/Metrics；
	- 推荐统一使用 OTLP（4317/gRPC、4318/HTTP）。历史服务可用 Jaeger Exporter 暂存，逐步切至 OTLP。

- 边缘 OTel Collector（本机 Agent）
	- 接收应用 OTLP（Traces 与自定义 Metrics），做初步聚合、批处理、属性补齐，可选限流与采样；
	- 向中心 OTel Collector 以 OTLP 转发，形成统一治理入口；
	- 可同时开启 Jaeger Receiver 以兼容历史 Jaeger Exporter 流量。

	端口：
	- 4317（OTLP gRPC）、4318（OTLP HTTP）
	- 可选：14250（Jaeger gRPC）、6831/6832（Jaeger UDP）用于兼容接入

- 中心 OTel Collector
	- 统一入口与治理：接收来自各主机“边缘 Collector”的 OTLP 流量；
	- 进行属性标准化、队列与重试、尾部采样（可选）、多租户路由与分流，导出至后端；
	- 端口：4317（OTLP gRPC）、4318（OTLP HTTP）。必要时开启 Jaeger Receiver 兼容历史链路。

- Jaeger 后端（存储/查询）
	- 接收来自 OTel Collector 的 Trace，提供查询 UI 与 API（常见 16686 是 Jaeger Query UI）。

- VictoriaMetrics（单机/集群）
	- 兼容 Prometheus 协议的时序存储；常见写入端口 8428（/api/v1/write）。

- Grafana
	- 默认 3000 端口；配置 Jaeger 与 Prometheus（VictoriaMetrics）数据源，提供仪表盘、Explore、告警等能力。

—

## 4.1 主机性能指标采集补充

除了服务通过 OTel SDK 采集的 Trace 和自定义 Metrics，实际生产环境还需关注主机层面的性能指标（如 CPU、内存、磁盘、网络等）。这类指标通常由 Node Exporter 部署在主机上，暴露 Prometheus 格式的 `/metrics` 接口。

边缘 OTel Collector 可通过 Prometheus Receiver（pull 模式）定时抓取主机性能指标，并与应用 Metrics 一并推送到中心 Collector，统一处理与存储。

数据流补充：

主机 Node Exporter → 边缘 OTel Collector（receivers.prometheus）→ 中心 OTel Collector → VictoriaMetrics

配置参考：

`edge-otel-collector.yaml` 增加 Prometheus Receiver：

```
receivers:
  otlp:
    protocols:
      grpc:
      http:
  jaeger:
    protocols:
      grpc:
      thrift_compact:
  prometheus:
    config:
      scrape_configs:
        - job_name: 'node'
          static_configs:
            - targets: ['localhost:9100']  # Node Exporter 默认端口

processors:
  batch: {}
  attributes:
    actions:
      - key: env
        value: prod
        action: upsert

exporters:
  otlp:
    endpoint: central-otel-collector:4317
    tls:
      insecure: true

service:
  pipelines:
    traces:
      receivers: [otlp, jaeger]
      processors: [batch]
      exporters: [otlp]
    metrics:
      receivers: [otlp, prometheus]
      processors: [batch]
      exporters: [otlp]
```

说明：
- `prometheus` receiver 负责定时抓取主机 Node Exporter 的 `/metrics`，与应用自定义 Metrics 一并汇总。
- 这样主机性能指标与服务业务指标可统一进入中心 Collector 和后端存储，便于统一分析与告警。

VictoriaMetrics 作为后端存储时，Grafana 可用同一 Prometheus 数据源同时查询主机与应用指标。

—

## 5. 配置参考（示意）

以下为可直接套用/调整的“最小可用”示例，便于快速连通链路。

### 5.1 应用侧（OTLP：Trace + Metrics）

推荐统一 OTLP 出口到“本机边缘 OTel Collector”：

```
OTEL_TRACES_EXPORTER=otlp
OTEL_METRICS_EXPORTER=otlp
OTEL_EXPORTER_OTLP_ENDPOINT=http://127.0.0.1:4317
OTEL_EXPORTER_OTLP_PROTOCOL=grpc
OTEL_SERVICE_NAME=your-service
OTEL_RESOURCE_ATTRIBUTES=service.namespace=hci,env=prod,region=cn

# 可选：指标收集细节（视语言 SDK 而定）
OTEL_METRICS_TEMPORALITY_PREFERENCE=cumulative
OTEL_METRIC_EXPORT_INTERVAL=10000  # ms
```

兼容路径（历史服务保留）：若暂只能用 Jaeger Exporter，则将目标指向本机 Jaeger Agent，由边缘/中心 Collector 接收后再导出。

### 5.2 边缘 OTel Collector（本机 Agent）

`edge-otel-collector.yaml`（关键片段，示意）：

```
receivers:
	otlp:
		protocols:
			grpc:
			http:
	# 可选：兼容 Jaeger 流量
	jaeger:
		protocols:
			grpc:
			thrift_compact:
  prometheus:
    config:
      scrape_configs:
        - job_name: 'node'
          static_configs:
            - targets: ['localhost:9100']  # Node Exporter 默认端口

processors:
	batch: {}
	attributes:
		actions:
			- key: env
				value: prod
				action: upsert

exporters:
	# 向中心 Collector 统一上送
	otlp:
		endpoint: central-otel-collector:4317
		tls:
			insecure: true

service:
	pipelines:
		traces:
			receivers: [otlp, jaeger]
			processors: [batch]
			exporters: [otlp]
		metrics:
			receivers: [otlp, prometheus]
			processors: [batch]
			exporters: [otlp]
```

### 5.3 中心 OTel Collector（汇聚分流）

`central-otel-collector.yaml`（关键片段，示意）：

```
receivers:
	otlp:
		protocols:
			grpc:
			http:
	# 可选：兼容 Jaeger
	jaeger:
		protocols:
			grpc:
			thrift_compact:

processors:
	batch: {}
	# 可选：尾部采样（按错误/慢调用留存）
	# tail_sampling:
	#   policies:
	#     - name: errors
	#       type: status_code
	#       status_code:
	#         status_codes: [ERROR]

exporters:
	jaeger:
		endpoint: jaeger-collector:14250
		tls:
			insecure: true
	prometheusremotewrite:
		endpoint: http://victoria-metrics:8428/api/v1/write

service:
	pipelines:
		traces:
			receivers: [otlp, jaeger]
			processors: [batch]
			exporters: [jaeger]
		metrics:
			receivers: [otlp]
			processors: [batch]
			exporters: [prometheusremotewrite]
```

### 5.4 兼容：Jaeger Agent（可选保留）

容器化示意（若历史服务强绑定 Jaeger Exporter）：

```
docker run -d --name=jaeger-agent --restart=always \
	--net=host \
	-e JAEGER_COLLECTOR_GRPC_HOST_PORT=edge-otel-collector:14250 \
	jaegertracing/jaeger-agent:latest
```

建议逐步迁移服务到 OTel SDK + OTLP，减少协议/组件耦合。

### 5.5 Grafana 数据源（简化示意）

在 Grafana 中添加：
- Prometheus（指向 VictoriaMetrics）
	- URL: http://victoria-metrics:8428
	- Access: Server
- Jaeger
	- URL: http://jaeger-query:16686

随后可按服务模板导入通用仪表盘；Trace 可在 Explore 中用 TraceID 搜索，或通过 Exemplars 从指标跳转到具体 Trace。

—

## 6. Trace 与 Metrics：相似性与差异

相似点：
- 形态：均是时间序列上的观测信号；
- 管道：SDK/Agent → Collector → 存储 → 可视化；
- 运维：同样需关注采样/批处理/压缩/标签规范/多租户与环境隔离；
- 关联：可通过 Exemplars、TraceID 标签实现跨域跳转。

差异点（实践关注）：
- 数据模型不同：Trace 是树状/图状时序跨度；Metrics 是标量时间序列。
- 读写模式不同：Trace 检索偏“按需”，Metrics 偏“连续聚合与告警”。
- 成本侧重点：Metrics 强调标签基数与保留策略；Trace 强调采样、保留与热/冷分层。

—

## 7. 最佳实践建议

- 资源属性规范（所有信号统一）：
	- service.name、service.namespace、service.version、deployment.environment（env）等；
	- 节点/容器信息（host.name、k8s.*、cloud.* 等）通过 Collector resourcedetection/attributes 处理器补齐。

- 采样与保留：
	- Trace：生产默认 5%～20% 基线采样（视流量与成本），对错误/慢调用启用尾部采样优先；
	- Metrics：控制高基数字段（如 user_id、request_id）严禁直接打标签；
	- 合理的保留周期与降采样策略（VictoriaMetrics 支持下采样）。

- 指标命名与标签：
	- 遵循 Prometheus 命名建议：单位后缀（_seconds/_bytes/_total 等），避免混用；
	- 控制标签基数，避免维度爆炸；
	- 用 job/instance 标识采集来源，统一 env/region/az 等环境标签。

- 可用性与扩展：
	- Collector 横向扩容，尽量本地就近接入；
	- 后端存储做高可用与冷热分层；
	- 关键链路 TLS/鉴权（mTLS、Basic/OAuth），最少权限与隔离网络。

- 体验与效率：
	- 建立服务模板与 SDK 引入规范，自动生成仪表盘与告警基线；
	- 落地 SLO/SLA（请求成功率、P95/P99、可用性目标）并闭环到告警。

—

## 8. 排障清单（连通性与质量）

连通性：
- 端口探测：
	- 边缘 OTel Collector：4317/4318（OTLP），可选 14250（Jaeger gRPC）、6831/6832（Jaeger UDP）
	- 中心 OTel Collector：4317/4318（OTLP），可选 14250/6831/6832 兼容
	- Jaeger Agent（兼容）：6831/6832（UDP），5778（采样）
	- VictoriaMetrics：8428（/api/v1/write, /api/v1/query）
	- Grafana：3000；Jaeger Query：16686

- 最小路径验证：
	- 应用 → 边缘 Collector：在应用侧打开 OTLP 调试日志，确认导出成功；
	- 边缘 → 中心 Collector：在边缘 Collector 日志中确认 otlpexporter 成功重试/发送；
	- Metrics：在中心 Collector 打开 debug，确认收到 otlp metrics 并成功 remote write；
	- Trace：Grafana/Jaeger 中按 service.name + 时间范围查看 Trace；
	- 后端：在 VictoriaMetrics 查询简单自定义 metrics 验证写入；

质量与成本：
- 指标基数飙升：排查新标签/动态值；必要时在 Collector 侧做 relabel/drop；
- Trace 过量：调整采样器，关键路径保留、非关键路径限流；
- 延迟高：检查 Collector 批处理大小、队列与后端写入带宽。

—

## 9. 版本与兼容性建议

- 统一核心版本窗口（OTel Collector、Jaeger、VictoriaMetrics、Grafana），避免协议/字段不兼容；
- 优先使用 OTLP 作为通用导出协议，便于未来扩展 Logs 与更丰富处理器；
- 逐步从“Jaeger Exporter → Jaeger Agent”迁移为“OTLP → Collector”（可选演进路径）。

—

## 10. 小结

本方案的价值在于：
- 架构同构：Trace 与 Metrics 共用 Collector 作为统一入口与治理层；
- 组件解耦：应用、Agent、Collector、存储、可视化相对独立，便于替换与扩展；
- 运维友好：链路可观测、问题可定位、容量可扩展、成本可控。

可按上文“配置参考”快速连通，随后按“最佳实践”持续收敛规范。

